#!/bin/bash

# Agregar directorios comunes de herramientas al PATH
export PATH="$PATH:$HOME/go/bin:$HOME/.local/bin"

# Configuraci√≥n
URL_INPUT="schriftlabor.at/"
# Asegurar que URL_INPUT tenga protocolo para herramientas que lo requieren
if [[ ! "$URL_INPUT" =~ ^https?:// ]]; then
    URL_COMPLETA="https://$URL_INPUT"
else
    URL_COMPLETA="$URL_INPUT"
fi

DOMINIO=$(echo "$URL_INPUT" | sed -E 's|^https?://||' | sed 's|/$||' | sed 's|/.*||')
DOMINIO_LIMPIO=$(echo "$DOMINIO" | sed 's/[^a-zA-Z0-9._-]/_/g')

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Funci√≥n para log
log() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Crear directorio de resultados
FECHA=$(date +%Y%m%d_%H%M%S)
DIR_RESULTADOS="scan_${DOMINIO_LIMPIO}_${FECHA}"
mkdir -p "$DIR_RESULTADOS"

echo "üéØ Escaneo de seguridad para: $URL_INPUT"
echo "=========================================="

# Verificar herramientas instaladas
log "Verificando herramientas de seguridad..."

declare -A HERRAMIENTAS=(
    ["subfinder"]="Enumeraci√≥n de subdominios"
    ["assetfinder"]="B√∫squeda de assets"
    ["waybackurls"]="URLs hist√≥ricas"
    ["gau"]="URLs de archivos"
    ["katana"]="Crawling"
    ["nuclei"]="Escaneo de vulnerabilidades"
    ["naabu"]="Escaneo de puertos"
    ["httpx"]="Verificaci√≥n HTTP"
    ["dnsx"]="Consulta DNS"
    ["ffuf"]="Fuzzing"
)

for tool in "${!HERRAMIENTAS[@]}"; do
    if command -v "$tool" >/dev/null 2>&1; then
        success "$tool - ${HERRAMIENTAS[$tool]}"
    else
        warn "$tool - No instalado"
    fi
done

# 1. ENUMERACI√ìN DE SUBDOMINIOS
log "Iniciando enumeraci√≥n de subdominios..."

> "$DIR_RESULTADOS/subs_temp.txt"

if command -v subfinder >/dev/null 2>&1; then
    log "Ejecutando subfinder..."
    subfinder -d "$DOMINIO" -silent >> "$DIR_RESULTADOS/subs_temp.txt" 2>&1
    SUBS_COUNT=$(wc -l < "$DIR_RESULTADOS/subs_temp.txt" 2>/dev/null || echo 0)
    log "Subfinder encontr√≥ $SUBS_COUNT subdominios"
else
    warn "subfinder no disponible"
fi

if command -v assetfinder >/dev/null 2>&1; then
    log "Ejecutando assetfinder..."
    assetfinder --subs-only "$DOMINIO" >> "$DIR_RESULTADOS/subs_temp.txt" 2>&1
    SUBS_COUNT=$(wc -l < "$DIR_RESULTADOS/subs_temp.txt" 2>/dev/null || echo 0)
    log "Assetfinder encontr√≥ $SUBS_COUNT subdominios totales"
else
    warn "assetfinder no disponible"
fi

# Verificar subdominios activos
if command -v httpx >/dev/null 2>&1 && [ -s "$DIR_RESULTADOS/subs_temp.txt" ]; then
    log "Verificando subdominios activos..."
    cat "$DIR_RESULTADOS/subs_temp.txt" | httpx -silent > "$DIR_RESULTADOS/subdominios_activos.txt"
fi

# 2. ENUMERACI√ìN DE URLs
log "Recolectando URLs..."

> "$DIR_RESULTADOS/urls_temp.txt"

if command -v waybackurls >/dev/null 2>&1; then
    log "Consultando Wayback Machine..."
    waybackurls "$DOMINIO" >> "$DIR_RESULTADOS/urls_temp.txt" 2>&1
    URLS_COUNT=$(wc -l < "$DIR_RESULTADOS/urls_temp.txt" 2>/dev/null || echo 0)
    log "Waybackurls encontr√≥ $URLS_COUNT URLs"
else
    warn "waybackurls no disponible"
fi

if command -v gau >/dev/null 2>&1; then
    log "Ejecutando gau..."
    gau "$DOMINIO" >> "$DIR_RESULTADOS/urls_temp.txt" 2>&1
    URLS_COUNT=$(wc -l < "$DIR_RESULTADOS/urls_temp.txt" 2>/dev/null || echo 0)
    log "Gau encontr√≥ $URLS_COUNT URLs totales"
else
    warn "gau no disponible"
fi

if command -v katana >/dev/null 2>&1; then
    log "Ejecutando crawler Katana..."
    katana -u "$URL_COMPLETA" -silent -jc -aff >> "$DIR_RESULTADOS/urls_temp.txt" 2>&1
    URLS_COUNT=$(wc -l < "$DIR_RESULTADOS/urls_temp.txt" 2>/dev/null || echo 0)
    log "Katana encontr√≥ $URLS_COUNT URLs totales"
else
    warn "katana no disponible"
fi

# 3. FILTRADO Y ORGANIZACI√ìN
log "Procesando resultados..."

# Subdominios √∫nicos y activos
sort -u "$DIR_RESULTADOS/subs_temp.txt" > "$DIR_RESULTADOS/subdominios.txt"
if [ -f "$DIR_RESULTADOS/subdominios_activos.txt" ]; then
    sort -u "$DIR_RESULTADOS/subdominios_activos.txt" > "$DIR_RESULTADOS/subdominios_activos_unicos.txt"
fi

# URLs organizadas por tipo
sort -u "$DIR_RESULTADOS/urls_temp.txt" > "$DIR_RESULTADOS/todas_urls.txt"

# Filtrar URLs interesantes
log "Filtrando URLs potencialmente vulnerables..."

# URLs con par√°metros (potenciales XSS/SQLi)
grep "?" "$DIR_RESULTADOS/todas_urls.txt" > "$DIR_RESULTADOS/urls_con_parametros.txt"

# Archivos sensibles
grep -E "\.(php|asp|aspx|jsp|config|env|sql|bak|old|backup|tar|gz)" "$DIR_RESULTADOS/todas_urls.txt" > "$DIR_RESULTADOS/archivos_sensibles.txt"

# Directorios administrativos
grep -E "(admin|login|dashboard|panel|config|api|upload|test|debug)" "$DIR_RESULTADOS/todas_urls.txt" > "$DIR_RESULTADOS/directorios_sensibles.txt"

# 4. ESCANEO DE VULNERABILIDADES
if command -v nuclei >/dev/null 2>&1; then
    log "Ejecutando escaneo de vulnerabilidades con Nuclei..."
    
    # Escanear URL principal
    nuclei -u "$URL_COMPLETA" -silent -o "$DIR_RESULTADOS/nuclei_principal.txt" &
    
    # Escanear subdominios activos si existen
    if [ -f "$DIR_RESULTADOS/subdominios_activos_unicos.txt" ] && [ -s "$DIR_RESULTADOS/subdominios_activos_unicos.txt" ]; then
        nuclei -list "$DIR_RESULTADOS/subdominios_activos_unicos.txt" -silent -o "$DIR_RESULTADOS/nuclei_subdominios.txt" &
    fi
    
    # Escanear URLs con par√°metros
    if [ -s "$DIR_RESULTADOS/urls_con_parametros.txt" ]; then
        nuclei -list "$DIR_RESULTADOS/urls_con_parametros.txt" -silent -o "$DIR_RESULTADOS/nuclei_parametros.txt" &
    fi
    
    wait
fi

# 5. ESCANEO DE PUERTOS
if command -v naabu >/dev/null 2>&1; then
    log "Escaneando puertos abiertos..."
    naabu -host "$DOMINIO" -silent -o "$DIR_RESULTADOS/puertos_abiertos.txt" 2>/dev/null
fi

# 6. FUZZING B√ÅSICO
if command -v ffuf >/dev/null 2>&1; then
    log "Ejecutando fuzzing b√°sico..."
    
    # Wordlist com√∫n para directorios
    cat > "$DIR_RESULTADOS/wordlist_temp.txt" << 'EOF'
admin
login
dashboard
api
config
backup
test
dev
phpmyadmin
wp-admin
administrator
uploads
images
css
js
EOF

    ffuf -u "$URL_COMPLETA/FUZZ" -w "$DIR_RESULTADOS/wordlist_temp.txt" -mc 200,301,302 -o "$DIR_RESULTADOS/fuzzing_directorios.json" -of json -s 2>/dev/null &
fi

# 7. AN√ÅLISIS DE INFORMACI√ìN EXPUESTA
log "Analizando informaci√≥n expuesta..."

# Headers de seguridad
if command -v curl >/dev/null 2>&1; then
    log "Analizando headers de seguridad..."
    curl -I -s "$URL_COMPLETA" > "$DIR_RESULTADOS/headers.txt"
    
    # Verificar headers de seguridad
    echo "=== HEADERS DE SEGURIDAD ===" > "$DIR_RESULTADOS/analisis_headers.txt"
    grep -i "server:\|x-powered-by:\|x-frame-options:\|content-security-policy:\|strict-transport-security:" "$DIR_RESULTADOS/headers.txt" >> "$DIR_RESULTADOS/analisis_headers.txt"
fi

# 8. GENERAR REPORTE
log "Generando reporte final..."

cat > "$DIR_RESULTADOS/reporte_final.txt" << EOF
üìä REPORTE DE SEGURIDAD - $DOMINIO
Fecha: $(date)
=========================================

ESTAD√çSTICAS:
-------------
Subdominios encontrados: $(wc -l < "$DIR_RESULTADOS/subdominios.txt" 2>/dev/null || echo 0)
Subdominios activos: $(wc -l < "$DIR_RESULTADOS/subdominios_activos_unicos.txt" 2>/dev/null || echo 0)
URLs totales: $(wc -l < "$DIR_RESULTADOS/todas_urls.txt" 2>/dev/null || echo 0)
URLs con par√°metros: $(wc -l < "$DIR_RESULTADOS/urls_con_parametros.txt" 2>/dev/null || echo 0)
Archivos sensibles: $(wc -l < "$DIR_RESULTADOS/archivos_sensibles.txt" 2>/dev/null || echo 0)

VULNERABILIDADES ENCONTRADAS:
----------------------------
$(if [ -f "$DIR_RESULTADOS/nuclei_principal.txt" ]; then
    echo "Principal: $(wc -l < "$DIR_RESULTADOS/nuclei_principal.txt")"
    cat "$DIR_RESULTADOS/nuclei_principal.txt" | head -5
fi)

$(if [ -f "$DIR_RESULTADOS/nuclei_subdominios.txt" ]; then
    echo "Subdominios: $(wc -l < "$DIR_RESULTADOS/nuclei_subdominios.txt")"
fi)

P√ÅGINAS SENSIBLES ENCONTRADAS:
-----------------------------
$(if [ -f "$DIR_RESULTADOS/todas_urls.txt" ]; then
    for pagina in admin login dashboard api config upload test debug; do
        count=$(grep -c "$pagina" "$DIR_RESULTADOS/todas_urls.txt" 2>/dev/null || echo 0)
        if [ "$count" -gt 0 ]; then
            echo "üîç /$pagina/: $count URLs"
        fi
    done
fi)

RECOMENDACIONES INMEDIATAS:
--------------------------
1. Revisar archivos sensibles encontrados
2. Verificar exposici√≥n de informaci√≥n en headers
3. Analizar URLs con par√°metros para XSS/SQLi
4. Revisar directorios administrativos expuestos

ARCHIVOS GENERADOS:
------------------
$(ls -la "$DIR_RESULTADOS" | grep "\.txt$" | awk '{print "  " $9 " (" $5 " bytes)"}')
EOF

# 9. MOSTRAR RESUMEN EJECUTIVO
echo ""
success "ESCANEO COMPLETADO!"
echo "======================"
echo "üìÅ Resultados en: $DIR_RESULTADOS"
echo ""
echo "üìä ESTAD√çSTICAS:"
echo "   ‚Ä¢ Subdominios: $(wc -l < "$DIR_RESULTADOS/subdominios.txt" 2>/dev/null || echo 0)"
echo "   ‚Ä¢ URLs totales: $(wc -l < "$DIR_RESULTADOS/todas_urls.txt" 2>/dev/null || echo 0)"
echo "   ‚Ä¢ URLs con par√°metros: $(wc -l < "$DIR_RESULTADOS/urls_con_parametros.txt" 2>/dev/null || echo 0)"

# Mostrar hallazgos cr√≠ticos
echo ""
echo "üö® HALLazGOS IMPORTANTES:"

# Vulnerabilidades cr√≠ticas
if [ -f "$DIR_RESULTADOS/nuclei_principal.txt" ] && [ -s "$DIR_RESULTADOS/nuclei_principal.txt" ]; then
    echo "   üî¥ Vulnerabilidades: $(wc -l < "$DIR_RESULTADOS/nuclei_principal.txt")"
    grep -i "critical\|high" "$DIR_RESULTADOS/nuclei_principal.txt" | head -3 | while read vuln; do
        echo "      ‚Ä¢ $vuln"
    done
fi

# Archivos sensibles
if [ -f "$DIR_RESULTADOS/archivos_sensibles.txt" ] && [ -s "$DIR_RESULTADOS/archivos_sensibles.txt" ]; then
    echo "   üü° Archivos sensibles: $(wc -l < "$DIR_RESULTADOS/archivos_sensibles.txt")"
fi

# Headers de seguridad
if [ -f "$DIR_RESULTADOS/analisis_headers.txt" ] && [ -s "$DIR_RESULTADOS/analisis_headers.txt" ]; then
    echo "   üîç Informaci√≥n expuesta en headers:"
    grep "Server:\|X-Powered-By:" "$DIR_RESULTADOS/analisis_headers.txt" | while read header; do
        echo "      ‚Ä¢ $header"
    done
fi

echo ""
echo "üìã Reporte completo: $DIR_RESULTADOS/reporte_final.txt"

# Limpiar archivos temporales
rm -f "$DIR_RESULTADOS"/*temp*

log "An√°lisis finalizado. Revisa los archivos en $DIR_RESULTADOS/"